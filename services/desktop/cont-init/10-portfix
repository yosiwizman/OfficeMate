#!/usr/bin/with-contenv sh
# Prepare nginx to expose Webtop on a dynamic external port without collisions.
# Strategy: keep Webtop's internal nginx on its default port (3000), and add a front
# server listening on $NGINX_PORT that proxies to 127.0.0.1:3000. Also create /healthz.
set -eu

# Capture any external PORT injected by the platform and persist it for services
if [ -n "${PORT:-}" ]; then
  echo "[10-portfix] Using external PORT=${PORT} for front nginx"
  printf "%s" "${PORT}" > /run/s6/container_environment/NGINX_PORT
  # Do not let the base image use $PORT directly
  printf "" > /run/s6/container_environment/PORT || true
fi

# Default front port if none provided
if [ ! -f /run/s6/container_environment/NGINX_PORT ]; then
  printf "%s" "3000" > /run/s6/container_environment/NGINX_PORT
fi

# Configure internal LinuxServer default site to avoid port clashes with the front server
# Move internal site off 3000/3001 unless the user has explicitly overridden
if [ ! -f /run/s6/container_environment/CUSTOM_PORT ]; then
  printf "%s" "3002" > /run/s6/container_environment/CUSTOM_PORT
fi
if [ ! -f /run/s6/container_environment/CUSTOM_HTTPS_PORT ]; then
  printf "%s" "3003" > /run/s6/container_environment/CUSTOM_HTTPS_PORT
fi

# Render front server from template, proxying to the internal HTTP port
export NGINX_PORT=$(cat /run/s6/container_environment/NGINX_PORT)
export UPSTREAM_HTTP_PORT=$(cat /run/s6/container_environment/CUSTOM_PORT)
/usr/bin/envsubst '$NGINX_PORT $UPSTREAM_HTTP_PORT' < /etc/nginx/conf.d/front.conf.tmpl > /etc/nginx/conf.d/front.conf

# Ensure nginx runtime dir exists
mkdir -p /run/nginx || true
